---
title: Malware Delivery via Fake Website in 2025
---

Ponieważ ostatnio zdarzało mi się dostarczać malware w ramach ćwiczeń redteamowych poprzez website udający legitną firmę, to w tym poście zaprezentuję wszystkie aspekty jakie trzeba wziąć pod uwagę realizując taki scenariusz

## Theory

Naszym celem jest dostarczyć link do strony internetowej na skrzynkę email ofiary. Email musi dotrzeć i nie trafić do spamu. Następnie zainteresowana ofiara musi kliknąć w link. Strona musi się otworzyć i nie zostać zablokowana na przeglądarce. Użytkownik nie może podejrzewać, że strona jest złośliwa, a następnie pobrać malware. Samo uruchomienie malware jest poza zakresem tego artykułu.

Są co najmniej trzy warstwy zabezpieczeń, które musimy wziąć pod uwagę przy realizacji takiego scenariusza:

1. Secure Email Gateway (SEG): wiadomość email zanim dotrze do skrzynki twojej ofiary zostanie przeskanowana przez SEG. Domena, z której wiadomość została nadana zostanie zweryfikowana, wszystkie linki zawarte w treści zostaną zweryfikowane, niektóre z nich zostaną otwarte przez sandbox skaner. Naszym celem jest prześlizgnięcie się under the radar of SEG, żeby trafić na skrzynkę ofiary.

2. Secure Web Gateway (SWG): gdy wiadomość już dotrze na skrzynkę, ofiara musi otworzyć link. Nasza strona może zostać zablokowana jeszcze przed załadowaniem przez SWG. SWG skanuje requesty, które wychodzą z Twojej przeglądarki i do niej trafiają. Wiele zależy od indywidualnej polityki ustawionej przez target company. SWG skanuje treść strony w czasie rzeczywistym i szuka złośliwych treści. Naszym celem jest prześlizgnięcie się under the radar of SWG, żeby strona została otworzona bez przeszkód na przeglądarce.

3. Human Gateway (HG): gdy już stronę uda się otworzyć w przeglądarce, to ofiara musi być przekonana, że strona jest bezpieczna i legitna. Odpowiednio zmotywowana ofiara jest w stanie wytłumaczyć sobie wiele rzeczy. W dbałości o szczegóły chodzi nie tylko o to, żeby ofiara pobrała malware, ale także o to, żeby nie zgłosiła do swojego CERTu podejrzanej strony. Naszym celem jest pobranie malware i pozostanie niewykrytymi.

4. *Security Bots: ostatni problem stanowią losowe boty crawlujące cały internet, które mogą oznaczyć naszą stronę jako złośliwą i zablokować do niej dostęp. Najpopularniejszym takim rozwiązaniem jest _Google Safe Browsing_.

## Scenario and branding

Musimy zacząć od wybrania charakteryzacji naszej strony. Zasadniczo są dwie możliwości:

- Strona, która podszywa się pod inną dobrze znaną naszemu celowi stronę.
- Strona, która udaje prawdziwą firmę, ale nią nie jest.

Należy pamiętać, że strona powinna uzasadniać pobieranie pliku. Wszystko zależy od celu ataku: innej strony i pretekstu użyjemy do ataku na HR, a innej na dział IT. Kilka inspiracji na scenariusze:

```text
        WEBSITE             |       PRETEXT
                            |
1. CV generator             | I want to work for you, here's my CV
2. training platform        | Check out this free materials and agenda
3. invoice generator        | You have an unpaid invoice!
4. 3rd-party file share     | Here you have the cooperation-related files
5. software company         | Download this security update immediately!
```

## Domain

Domena jest pierwszą rzeczą, na którą patrzy SEG i SWG. Jest to też często jedyna rzecz, po której ofiara jest w stanie się zorientować, że strona którą odwiedza jest złośliwa.

Zasadniczo są dwie skuteczne możliwości wyboru domeny: expired domain with reputation and trusted domain. Poniżej przedstawiam obie z nich.

- Is WHOIS "leak" possible?

### Expired domain

Miliony domen codziennie wygasa na całym świecie [*]. Większość z nich została kupiona na zapas i nigdy nie była wykorzystana. Interesują nas jednak te, które były aktywnie wykorzystywane w przeszłości.

Na stronie [expireddomains.net](https://expireddomains.net) (po zalogowaniu) możemy przeszukiwać wygasłe domeny. Z mojego doświadczenia wynika, że sortowanie po "backlinks" daje najlepsze rezultaty - im więcej, tym większa szansa, że domena była faktycznie używana, czyli zyskała reputację.

Przy wybieraniu wygasłej domeny ważne są trzy sprawy:

**1. Categorization**: domena powinna być skategoryzowana tak, żeby najlepiej odpowiadała profilowi atakowanej firmy. Jeśli przeprowadzamy ćwiczenia dla klienta finansowego, to domena z kategorii "biznes" i "finanse" może być traktowana jako bezpieczna przez systemy SEG i SWG.

**2. Reputation**: najważniejsze, żeby domena nie była oceniona jako złośliwa lub phishingowa. Większość domen ma reputację neutralną. Idealnie jeśli reputacja domeny jest pozytywna lub zaufana.

We can verify domain categorization and reputation using following free security providers:

- [SpamHaus](https://www.spamhaus.org/domain-reputation/)
- [IBM X-Force](https://exchange.xforce.ibmcloud.com/)
- [Cisco Talos](https://www.talosintelligence.com/reputation_center/lookup?search=example.com)
- [Trellix](https://trustedsource.org/en/feedback/url?action=checksingle&url=&product=00)
- [Forcepoint](https://support.forcepoint.com/s/site-lookup)
- [VirusTotal](https://www.virustotal.com/gui/domain/refpa.top)
- [MX Toolbox](https://mxtoolbox.com/blacklists.aspx)

Zasada jest prosta: im więcej serwisów skategoryzowało naszą domenę, tym lepiej. Zazwyczaj Cisco Talos i IBM X-Force są najbardziej restrykcyjne - polecam zaczynać od nich.

**3. History**: im domena świeższa tym lepsza. Dobrze jeśli domena ma historię dostępną w serwisie takim jak [Web Archive](https://web.archive.org/).

### Trusted domain

Drugą techniką, coraz częściej używaną, jest wykorzystanie znanych platform, które oferują unikatowy link do zasobu. Te duże platformy zazwyczaj dają własny zaufany certyfikat TLS i trudno je zablokować, aby nie zepsuć znacznej części internetu. Taka usługa może działać jako hosting lub proxy.

Jednym z takich serwisów jest Azure, który pozwala na ustawienie własnej subdomeny w domenie `*.azurewebsites.net`. Certyfikat TLS wydany przez Microsoft jest bardzo lubiany przez różnego rodzaju rozwiązania typu SEG i SWG.

Another examples:

- *.amazonaws.com
- *.netlify.app
- *.github.io
- More: [LoTS Project](https://lots-project.com/)

## Building website

Czas na zbudowanie naszej strony! Na początku skupimy się na ogólnym developmencie, później przejdziemy do szczegółów związanych z serwowaniem malware.

Ja polecam następujący stos technologiczny:

- [Bun](https://bun.sh/) - JS runtime i manager pakietów w jednym
- [Vite](https://vite.dev/) - serwer developerski i bundler (kompilator)
- [React](https://react.dev/) - framework frontendowy

Wiem, że dla kogoś kto nie siedzi na codzień we frontendzie może brzmieć to trochę skomplikowanie, ale zaraz wszystko się wyjaśni.

**Przecież to tylko prosta website, dlaczego nie mogę użyć po prostu HTMLa i JavaScriptu?!** Właściwie możesz, ale odradzam. Użycie nowoczesnego stacku frontendowego daje nam naturalną ochronę przed skanerami. Strony napisane w Reacie (bez Server Side Renderingu, tylko SPA) to w 95% zminifikowany i obfuskowany JavaScript. Większość skanerów po pierwsze w ogóle nie uruchamia JavaScriptu, a jego statyczna analiza jest właściwie niemożliwa. Jeśli skaner spróbuje wyrenderować czysty HTML, to nie zobaczy właściwie nic. Dodatkowo, korzystając z managera pakietów jesteśmy w stanie używać tych wszystkich bibliotek dostępnych w repozytoriach [NPM](https://www.npmjs.com/), co tylko dodaje naszej stronie autentyczności i powoduje wzrost skomplikowania kodu. Generalnie - my mamy większe możliwości, a skanery nie potrafią sobie z tym poradzić. I nie jest to podejrzane, ponieważ bardzo duża część dzisiejszego internetu działa właśnie w ten sposób.

Żyjemy w dobie AI więc możesz użyć jakiegoś AI do wygenerowania potrzebnego kodu. Ponieważ nie jest to post o pisaniu frontendu, to nie będę się bardziej w to zagłębiał.

Do CSSa polecam bibliotekę [Tailwind](https://tailwindcss.com/). Jest banalna w obsłudze i wszystkie modele AI dobrze radzą sobie z generowaniem kodu z użyciem Tailwind.

**UWAGA**: Nie polecam dołączać żadnych zasobów z jakiejkolwiek zewnętrznej domeny. Nie używaj Tailwaind hostowanego na CDN i podobnych! Niektóre rozwiązania typu SWG mogą wyświetlić twoją stronę, ale zablokować dostęp do zasobów zewnętrznych, przez co użytkownik dostanie niekompletną stronę, która wygląda bardzo podejrzanie.

O czym warto pamiętać:

- Strona musi wyglądać profesjonalnie, żeby wyglądać wiarygodnie.
- Branding ma znaczenie, im więcej danych tym lepiej: logo, numery telefonów, adresy email, nazwiska.
- Stockowe grafiki dodają wiarygodności.
- Zadbaj o podstawowe meta tags: tytuł, opis, język, kodowanie.
- Favicona dodaje wiarygodności.

**UWAGA**: Jeśli masz zamiar przesłać link przez jakiś komunikator (Slack, Teams, WhatsApp, Signal, Messanger, LinkedIn) to rozważ zaimplementowanie OpenGraph tags. Pozwoli to na wyświetlenie profesjonalnej miniaturki strony z podpisem.

TODO: grafika OG

Po zbudowaniu projektu dostaniesz statyczne pliki, które możesz hostować na dowolnym serwerze (nie ma kodu backendowego).

## Decoy file

Ostatnia rzecz, której potrzebujemy żeby uwiarygodnić nasze działania to decoy file. Są przypadki, kiedy nie możemy użytkownikowi serwować naszego uzbrojonego payloadu. Na przykład jeśli wykryjemy bota, lub klient korzysta z Maca, a nasz malware jest przygotowany tylko na Windowsa. Możemy też mieć jakieś inne specyficzne warunki, które muszą zostać spełnione. W zależności od scenariusza będziemy potrzebowali nieszkodliwego pliku, który nie zdradzi naszej operacji.

W moim przypadku najczęściej jest to PDF, który łatwo możemy przygotować przy użyciu [Canva](https://www.canva.com/) lub Microsoft Office.

## Malware download mechanism

WRESZCIE!!! Ile można czekać?!

### Malware Smuggling & OPSEC

Naszym celem w przypadku malware'u jest dostarczenie go do przeglądarki użytkownika w taki sposób, aby pozostał niewykryty przez SWG. Po kliknięciu przycisku "pobierz" plik powinien być już konstruowany lokalnie i żaden request HTTP nie powinien być wykonywany.

Sposobów na przeszmuglowanie malware'u jest całe mnóstwo. Prawdę mówiąc, SWG nie radzą sobie dobrze nawet z tymi najbardziej podstawowymi technikami. Klasyczna metoda to "hiding in plain sight": w skrypcie JS (najłatwiejsze), grafice (klasyczna steganografia), plikach SVG i tak dalej. Ta technika wykorzystuje najbardziej podstawowy mechanizm HTTP request-response. Przeglądarki implementują jeszcze cały szereg innych protokołów (na przykład: WebRTC, gRPC, WebSocket, Server Sent Events), które zazwyczaj w ogóle nie są monitorowane przez SWG. Póki co jednak "hiding in plain sight", nawet w tej najbardziej podstawowej formie z plikiem JS, nigdy mnie nie zawiodło. Być może w przyszłości będzie potrzeba stosowania bardziej wyszukanych technik.

Więcej o technikach szmuglowania malware'u i omijania SWG w poniższej DEFCON prezentacji: [Breaking Secure Web Gateways for Fun and Profit](https://sectube.tv/videos/RtmBcYZ0pIJk7a3w). Demo wielu różnych technik dostępne tutaj: [browser.security](https://browser.security/).

TODO: Szmuglowanie malware bez interakcji usera (pre-smuggling)
TODO: fire JS download using HTML injection (script tag)
TODO: payload jugling
TODO: code snippet

### Anti-Scanners & Anti-Sandbox Measures

Żeby hostować złośliwą stronę musimy powziąć pewne środki ostrożności. Jak już wspominałem, zagrożeniem dla nas są wszystkie skanery (SEG, SWG, Google Safe Browsing), które mogą przeprowadzać statyczną i dynamiczną analizę strony w oparciu o kontrolowany sandbox.

**Nie kopiuj kodu legitnej strony.** Bardzo odradzam dosłowne kopiowanie kodu legitnej strony. Jeśli Google Safe Browsing to wykryje, to jesteśmy skończeni. Kopiowanie kodu powoduje, że musimy podjąć bardzo radykalne środki - np. włączyć CloudFlare captchę dla wszystkich odwiedzających. Nawet jeśli nam się to uda, to nie gwarantuje, że SWG nie zablokuje nam strony już w trakcie odwiedzin. Możemy natomiast naśladować legitną stronę za pomocą własnego kodu. Z użyciem nowoczesnego stacku frontendowego kod będzie właściwie zawsze unikatowy, co zwiększa naszą pewność w konfrontacji ze skanerami.

**Jak wykryć sandbox?** Kilka rzeczy, które możemy zrobić:

1. Próba wykonania JavaScript - większość skanerów nadal nie uruchamia JavaScriptu! Użycie Reacta właściwie daje nam to zabezpieczenie out-of-the-box.
2. Timeout - zaczekajmy 1-2 sekundy zanim zaczniemy szmuglować malware. Ofiara prawdopodobnie i tak nie kliknie szybciej. Jeśli sandbox czeka na rendering strony, to sekunda oczekiwania już go prawdopodobnie zniechęci.
3. OS detection - jeśli OS nie zgadza się z naszym celem, to szmugluj niegroźny decoy file. Zabezpieczy nas to przed spaleniem operacji.
4. Screen size - boty często ustawiają niepoprawny rozmiar ekranu. Dzięki temu jesteśmy też w stanie wykryć użytkowników urządzeń mobilnych, którym nie chcemy serwować naszego malware'u.
5. User Agent - boty często mają nietypowy User Agent, który nie pasuje do rzeczywistych użytkowników.
6. Obfuscated magic string - korzystając z jednego z dostępnych obfuskatorów możemy konstruować magiczny ciąg znaków, który jest nazwą pliku naszego uzbrojonego payloadu. Reverse engineering może zabrać trochę czasu.
7. Trap buttons - dodaj ukryte buttony pułapki, które kliknie jedynie bot. W ten sposób rozpoznamy, jeśli bot chodzi po stronie.
8. Złe praktyki HTML - korzystanie ze złych praktyk HTMLa może w naturalny sposób zaciemniać znaczenie naszego kodu. Np. wykorzystanie elementu `div` z akcją `onclick` zamiast klasycznego elementu `button` może spowodować, że sandbox go nie kliknie.

TODO: snippet

## Final setup

Ostatnim krokiem jest ukrycie naszego faktycznego adresu IP za usługą CloudFlare. Jest to niezbędny krok do dobrego OPSEC. Nawet jeśli nasza domena zostanie zablokowana, będziemy mogli użyć innej, ponieważ adres IP faktycznego serwera nie zostanie odkryty.

Dodatkowo CloudFlare daje nam zabezpieczenie przed botami.

- CloudFlare
- Captcha
- Security and anti-bot fighting
