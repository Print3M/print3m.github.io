---
title: Windows privilege escalation
---

## Extracting NTLM hash

```powershell
mimikatz.exe
```

### From local SAM
SAM (Security Account Manager) is a database with all the **local user** accounts and passwords. It acts as a database. Passwords, which are stored in the SAM, are hashed. SAM data is used by LSASS to verify user credentials.

Mimikatz is one of the tools that are able to dump SAM file hashes.

```powershell
# Mimikatz
> privilege::debug
> token::elevate
> lsadump::sam
```

Metasploit, when the session is already established, has built-in ability to dump SAM hashes.

```bash
# Meterpreter
meterpreter > hashdump
```

CrackMapExec tool is able to remotely dump SAM hashes (via SMB using credentials).

```bash
crackmapexec smb <target-ip> -u <username> -p <password> --sam
```

### From LSASS memory
LSASS (_Local Security Authority Subsystem Service_) is a process running on every Windows OS. It verifies users logging, handles password changes, creates access tokens, writes to the Windows Security Log. In a domain environment LSASS communicates with a Domain Controller. It manages NTLM, Kerberos, NetLogon authentication. It's not possible to use Windows without `lsass.exe` running. An attacker is able to dump the LSASS process memory and retrieve NTLM hashes.

Tips:

* Memory dump must be performed after logging in successfully. Correct data must be provided to LSASS process before extraction.
* Memory dump should be performed from SYSTEM or local Administrator account.
* Not secured LSASS memory dump can be performed using built-in Windows tools (e.g. [dump.exe](https://lolbas-project.github.io/lolbas/OtherMSBinaries/Dump64/)). Then credentials can be extracted offline.

LSASS process might have additional security layer called _LSA protection_. It can be omitted with tools like **Mimikatz**.

```powershell
# Mimikatz
> privilege::debug
> token::elevate
> sekurlsa::msv
```
